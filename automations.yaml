# ==========================================
# PRESENCE DETECTION
# ==========================================

- id: '1645121972503'
  alias: Presence: Turn On Lights on Arrival
  description: Activates living room evening scene and entryway lamp when family arrives home
  triggers:
  - trigger: state
    entity_id: group.family
    from: not_home
    to: home
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.living_room_evening
  - action: light.turn_on
    target:
      entity_id: light.hue_white_lamp_1_12
  mode: single
- id: '1645123251752'
  alias: Presence: Turn Off Lights on Departure
  description: Turns off dining, kitchen, and living room lights when everyone leaves home
  triggers:
  - trigger: state
    entity_id: group.family
    from: home
  actions:
  - action: light.turn_off
    target:
      entity_id:
      - light.dining
      - light.kitchen
      - light.living_room
  mode: single

# ==========================================
# SYSTEM MONITORING
# ==========================================

- id: '1645381876007'
  alias: System: Low Disk Google Drive Warning
  description: Sends notification when Google Drive backup storage is full
  triggers:
  - trigger: state
    entity_id: binary_sensor.backups_stale
    from: 'off'
    to: 'on'
  actions:
  - action: notify.mobile_app_lucy
    data:
      title: Low Disk Warning
      message: Google Drive Backup Full
  mode: single

# ==========================================
# LIGHTING
# ==========================================

- id: '1645397215018'
  alias: Lighting: Living Room Evening Scene Before Sunset
  description: Activates living room evening scene 45 minutes before sunset
  triggers:
  - trigger: sun
    event: sunset
    offset: -00:45:00
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.living_room_evening
  mode: single
- id: '1645655609188'
  alias: Lighting: Dining Room Motion Light (Nighttime)
  description: Motion-activated entryway light during nighttime hours using blueprint
  use_blueprint:
    path: freakshock88/motion_illuminance_activated_entity.yaml
    input:
      target_entity: light.dining_room_entry_way_light
      time_limit_after: input_datetime.bedtime
      time_limit_before: input_datetime.wakeuptime
      no_motion_wait: input_number.10
      motion_sensor: binary_sensor.4_in_1_sensor_home_security_motion_detection
- id: '1645823910978'
  alias: Lighting: Turn Off Basement Light at Bedtime
  description: Turns off laundry area smart plug at bedtime
  triggers:
  - trigger: time
    at: input_datetime.bedtime
  actions:
  - action: switch.turn_off
    target:
      entity_id: switch.laundry_area_mini_smart_plug
  mode: single
- id: '1646458551450'
  alias: Lighting: Hallway Motion Light After Sunset
  description: Motion-activated hallway light after sunset using blueprint
  use_blueprint:
    path: Marcos_Felipe/turn-light-on-and-off-based-on-detected-motion-with-sun-condition.yaml
    input:
      motion_entity: binary_sensor.lumi_lumi_sensor_motion_aq2_eb14f807_ias_zone
      sunset_offset: 60
      light_target:
        entity_id:
        - light.hallway

# ==========================================
# SECURITY - LOCKS & DOORS
# ==========================================

- id: '1647141300603'
  alias: Security: Lock Doors on Departure
  description: Locks side door and garage door when either person leaves home
  triggers:
  - trigger: state
    entity_id: person.sam
    from: home
  - trigger: state
    entity_id: person.brandon
    from: home
  actions:
  - action: lock.lock
    target:
      entity_id: lock.side_door
  - action: lock.lock
    target:
      entity_id: lock.garage_door
  mode: single
- id: '1647141493933'
  alias: Security: Unlock Doors on Arrival
  description: Unlocks side door and garage door when either person arrives home
  triggers:
  - trigger: state
    entity_id: person.brandon
    from: not_home
    to: home
  - trigger: state
    entity_id: person.sam
    from: not_home
    to: home
  actions:
  - action: lock.unlock
    target:
      entity_id: lock.side_door
  - action: lock.unlock
    target:
      entity_id: lock.garage_door
  mode: single
- id: '1647906425536'
  alias: Security: Auto-Lock Side Door After 20min
  description: Auto-locks side door 20 minutes after being unlocked
  triggers:
  - trigger: state
    entity_id:
    - lock.side_door
    to: unlocked
    for:
      minutes: "{{ states('input_number.auto_lock_delay_minutes') | int }}"
  actions:
  - action: lock.lock
    target:
      entity_id: lock.side_door
  mode: single
- id: '1692626003293'
  alias: Security: Auto-Lock Garage Door After 20min
  description: Auto-locks garage door 20 minutes after being unlocked
  triggers:
  - trigger: state
    entity_id: lock.garage_door
    from: locked
    to: unlocked
    for:
      minutes: "{{ states('input_number.auto_lock_delay_minutes') | int }}"
  actions:
  - action: lock.lock
    target:
      entity_id: lock.garage_door
  mode: single
- id: '1692649106009'
  alias: Security: Unlock Garage When Side Door Opens
  description: Unlocks garage door when side door is unlocked for convenient access
  triggers:
  - trigger: state
    entity_id: lock.side_door
    from: locked
    to: unlocked
  actions:
  - action: lock.unlock
    target:
      entity_id: lock.garage_door
  mode: single

# ==========================================
# SENSOR OFFLINE NOTIFICATIONS
# ==========================================

- id: '1715257566631'
  alias: Sensors: Refrigerator Sensor Offline Alert
  description: Alerts when refrigerator contact sensor becomes unavailable
  triggers:
  - trigger: state
    entity_id: binary_sensor.lumi_lumi_sensor_magnet_aq2_ab18e107_on_off
    to: unavailable
  actions:
  - action: notify.family_devices
    data:
      message: Refrigerator contact sensor is offline
  mode: single
- id: '1715278725417'
  alias: Sensors: Side Door Sensor Offline Alert
  description: Alerts when side door contact sensor becomes unavailable
  triggers:
  - trigger: state
    entity_id: binary_sensor.dining_room_door_opening
    to: unavailable
  actions:
  - action: notify.mobile_app_lucy
    data:
      message: Side Door Close Sensor Unavailable
  mode: single
- id: '1715280746230'
  alias: Alerts: Gate Left Open
  description: Sends notification when upstairs gate is left open
  triggers:
  - trigger: device
    type: not_opened
    device_id: 1b838e6a0107f9c966cc779db3fc9396  # Upstairs gate sensor device
    entity_id: 6e60ff4f8694be9e0de4370799d590b2  # Upstairs gate binary sensor
    domain: binary_sensor
  conditions:
  - condition: state
    entity_id: binary_sensor.upstairs_gate_reversed
    state: 'on'
  actions:
  - action: notify.family_devices
    data:
      message: Gate Left Open
  mode: single
- id: '1715282125188'
  alias: Sensors: Side Door Device Offline Alert
  description: Alerts when side door contact sensor goes offline
  triggers:
  - trigger: device
    device_id: 1b838e6a0107f9c966cc779db3fc9396  # Side door contact sensor device
    domain: zha
    type: device_offline
    subtype: device_offline
  actions:
  - action: notify.mobile_app_lucy
    data:
      message: Side Door Contact Sensor Offline
  mode: single

# ==========================================
# DOOR & APPLIANCE ALERTS
# ==========================================

- id: '1715865574852'
  alias: Alerts: Refrigerator Door Left Open
  description: Alerts when refrigerator door has been left open for 5 minutes
  triggers:
  - trigger: device
    type: opened
    device_id: dec89cf186ff751b9b291d485f0a06fb  # Refrigerator door sensor device
    entity_id: fb7d3323821a5156dbe17343d093b1d3  # Refrigerator door binary sensor
    domain: binary_sensor
    for:
      minutes: "{{ states('input_number.refrigerator_door_alert_minutes') | int }}"
  actions:
  - action: notify.family_devices
    data:
      message: Refrigerator Left Open
  mode: single
- id: '1735850719491'
  alias: Controls: Basement Light Remote Toggle
  description: Toggles basement light using remote button short press
  triggers:
  - trigger: device
    device_id: 5d0879c339587ed7b1445c2fdb912d0f  # Basement remote button device
    domain: zha
    type: remote_button_short_press
    subtype: remote_button_short_press
  actions:
  - action: switch.toggle
    target:
      device_id: 67a94d70b691877adf8fe8da8f6bdb31  # Basement light switch device
  mode: single
- id: '1750263486910'
  alias: Alerts: Side Door Open Timer
  description: Sends periodic notifications with elapsed time when side door is left open
  triggers:
  - trigger: state
    entity_id: binary_sensor.dining_room_door_opening
    to: 'on'
    for:
      minutes: 1
  actions:
  - variables:
      opened_at: '{{ trigger.to_state.last_changed }}'
  - action: notify.family_devices
    data:
      message: "{% set elapsed = as_timestamp(now()) - as_timestamp(opened_at) %}
        {% set mins = (elapsed // 60) | int %} {% set secs = (elapsed % 60) | round(0)
        | int %} {% if mins < 1 %}\n  Side Door has been open for {{ secs }} second{{
        '' if secs == 1 else 's' }}\n{% else %}\n  Side Door has been open for {{
        mins }} minute{{ '' if mins == 1 else 's' }}{% if secs > 0 %} and {{ secs
        }} second{{ '' if secs == 1 else 's' }}{% endif %}\n{% endif %}\n"
  - repeat:
      while:
      - condition: state
        entity_id: binary_sensor.dining_room_door_opening
        state: 'on'
      sequence:
      - wait_for_trigger:
        - trigger: state
          entity_id: binary_sensor.dining_room_door_opening
          to: 'off'
        timeout:
          minutes: 1
        continue_on_timeout: true
      - choose:
        - conditions:
          - condition: state
            entity_id: binary_sensor.dining_room_door_opening
            state: 'on'
          sequence:
          - action: notify.family_devices
            data:
              message: "{% set elapsed = as_timestamp(now()) - as_timestamp(opened_at)
                %} {% set mins = (elapsed // 60) | int %} {% set secs = (elapsed %
                60) | round(0) | int %} {% if mins < 1 %}\n  Side Door has been open
                for {{ secs }} second{{ '' if secs == 1 else 's' }}\n{% else %}\n
                \ Side Door has been open for {{ mins }} minute{{ '' if mins == 1
                else 's' }}{% if secs > 0 %} and {{ secs }} second{{ '' if secs ==
                1 else 's' }}{% endif %}\n{% endif %}\n"
  - action: notify.family_devices
    data:
      message: '{% set elapsed = as_timestamp(now()) - as_timestamp(opened_at) %}
        {% set mins = (elapsed // 60) | int %} {% set secs = (elapsed % 60) | round(0)
        | int %} Side Door is Closed (was open for {% if mins < 1 %}{{ secs }} second{{
        '''' if secs == 1 else ''s'' }}{% else %}{{ mins }} minute{{ '''' if mins
        == 1 else ''s'' }}{% if secs > 0 %} and {{ secs }} second{{ '''' if secs ==
        1 else ''s'' }}{% endif %}{% endif %})

        '
  mode: restart

# ==========================================
# APPLIANCES
# ==========================================

- id: '1757278829721'
  alias: Appliances: Washing Machine Started
  description: Tracks when washing machine starts running based on power consumption
  triggers:
  - trigger: device
    type: power
    device_id: dbbbffb1a9780f1bc4ab76b8eb41dd56  # Washing machine power monitor device
    entity_id: a23b7a2760cf879c016f2e7ba670341d  # Washing machine power sensor
    domain: sensor
    above: 50
    for:
      hours: 0
      minutes: 0
      seconds: 3
  conditions:
  - condition: state
    entity_id: input_boolean.washing_machine
    state: 'off'
  actions:
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.washing_machine
  mode: single
- id: '1757280220535'
  alias: Appliances: Washing Machine Finished
  description: Sends notification when washing machine cycle is complete
  triggers:
  - trigger: device
    type: power
    device_id: dbbbffb1a9780f1bc4ab76b8eb41dd56  # Washing machine power monitor device
    entity_id: a23b7a2760cf879c016f2e7ba670341d  # Washing machine power sensor
    domain: sensor
    below: 8
    for:
      hours: 0
      minutes: 1
      seconds: 0
  conditions:
  - condition: state
    entity_id: input_boolean.washing_machine
    state: 'on'
  actions:
  - action: notify.family_devices
    data:
      message: Washing Machine is done
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.washing_machine
  mode: single
- id: '1757284769345'
  alias: Appliances: Dryer Started
  description: Tracks when dryer starts running based on vibration sensor
  triggers:
  - trigger: device
    type: turned_on
    device_id: 7914c337e4bcb80e0feef9e4cdc52b32  # Dryer vibration sensor device
    entity_id: 52627a28e42e6c1cab862def765a6274  # Dryer vibration binary sensor
    domain: binary_sensor
    for:
      hours: 0
      minutes: 2
      seconds: 0
  actions:
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.drying_machine_on
  mode: single
- id: '1757285511184'
  alias: Appliances: Dryer Finished
  description: Sends notification when dryer cycle is complete
  triggers:
  - trigger: device
    type: turned_off
    device_id: 7914c337e4bcb80e0feef9e4cdc52b32  # Dryer vibration sensor device
    entity_id: 52627a28e42e6c1cab862def765a6274  # Dryer vibration binary sensor
    domain: binary_sensor
    for:
      minutes: "{{ states('input_number.appliance_done_delay_minutes') | int }}"
  conditions:
  - condition: state
    entity_id: input_boolean.drying_machine_on
    state: 'on'
  actions:
  - action: notify.family_devices
    data:
      message: Dryer is done
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.drying_machine_on
  mode: single
- id: '1757637011062'
  alias: Lighting: Entryway Motion Light with Luminance
  description: Motion-activated entryway light with illuminance threshold using blueprint
  use_blueprint:
    path: freakshock88/motion_illuminance_activated_entity.yaml
    input:
      motion_sensor: binary_sensor.4_in_1_sensor_home_security_motion_detection
      target_entity: light.hue_white_lamp_1_12
      illuminance_cutoff: input_number.61_100
      illuminance_sensor: sensor.4_in_1_sensor_illuminance
      no_motion_wait: input_number.10
- id: '1757765608105'
  alias: Lighting: Porch Lights Sunset/Sunrise Schedule
  description: Turns porch lights on 30min before sunset and off 30min after sunrise
  triggers:
  - trigger: sun
    event: sunrise
    offset: 00:30:00
    id: Sunrise
  - trigger: sun
    event: sunset
    offset: -00:30:00
    id: Sunset
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: Sunrise
      sequence:
      - action: light.turn_off
        target:
          device_id: 165e6e79df5e78a6b759625a235bcc15  # Porch lights device
    - conditions:
      - condition: trigger
        id: Sunset
      sequence:
      - action: light.turn_on
        target:
          device_id: 165e6e79df5e78a6b759625a235bcc15  # Porch lights device
  mode: single

# ==========================================
# SCENES & TOGGLES
# ==========================================

- id: '1757785892027'
  alias: Scenes: Kitchen Time To Cook Toggle
  description: Activates kitchen cooking scene or normal scene based on toggle state
  triggers:
  - trigger: state
    entity_id: input_boolean.kitchen_time_to_cook
    to: 'on'
    id: Kitchen Time To Cook On
  - trigger: state
    entity_id: input_boolean.kitchen_time_to_cook
    to: 'off'
    id: Kitchen Time To Cook Off
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: Kitchen Time To Cook On
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.kitchen_time_to_cook
    - conditions:
      - condition: trigger
        id: Kitchen Time To Cook Off
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.kitchen_normal
  mode: single
- id: '1757806993161'
  alias: Lighting: Turn On Patio Lights at Night
  description: Turns on patio lights when side door opens during evening/night hours (from 30min before sunset onwards)
  triggers:
  - trigger: device
    type: opened
    device_id: 1b838e6a0107f9c966cc779db3fc9396  # Side door sensor device
    entity_id: 6e60ff4f8694be9e0de4370799d590b2  # Side door binary sensor
    domain: binary_sensor
  conditions:
  - condition: sun
    after: sunset
    after_offset: -00:30:00
  - condition: device
    type: is_off
    device_id: a235b93cf4f9b819e0554e6b4062cbf6  # Patio lights switch device
    entity_id: 3a3ff6e8b6da2c8f2cfc403aaedb12de  # Patio lights switch entity
    domain: switch
  actions:
  - action: switch.turn_on
    target:
      entity_id: switch.patio_lights
  mode: single
- id: '1757814638355'
  alias: Controls: Wake Kitchen Tablet on Motion
  description: Disables kitchen tablet screensaver when motion detected
  triggers:
  - trigger: device
    type: motion
    device_id: 64325f8051beb554b767e4e549e81c13  # Kitchen tablet motion sensor device
    entity_id: c38727677330bab1e94c53e76156cc62  # Kitchen tablet motion binary sensor
    domain: binary_sensor
  actions:
  - action: switch.turn_off
    target:
      entity_id: switch.kitchen_tablet_screensaver
  mode: restart
- id: '1757859609946'
  alias: Lighting: Kitchen Motion Light
  description: Turn on kitchen light on motion if dark, respects manual override
  triggers:
  - trigger: state
    id: motion_on
    entity_id: binary_sensor.kitchen_motion_sensor
    to: 'on'
  - trigger: state
    entity_id: light.kitchen
    to: 'on'
    id: manual_on
  - trigger: state
    entity_id: light.kitchen
    to: 'off'
    id: manual_off
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: motion_on
      - condition: numeric_state
        entity_id: sensor.kitchen_motion_sensor_illuminance
        below: "{{ states('input_number.motion_light_illuminance_threshold') | int }}"
      - condition: state
        entity_id: input_boolean.auto_light_override
        state: 'off'
      sequence:
      - action: light.turn_on
        target:
          entity_id: light.kitchen
    - conditions:
      - condition: trigger
        id: manual_on
      sequence:
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.auto_light_override
    - conditions:
      - condition: trigger
        id: manual_off
      sequence:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.auto_light_override
  mode: restart
- id: '1758999999999'
  alias: Controls: Kitchen Light Manual Override
  description: Allows dashboard toggle control of kitchen light automation override
  triggers:
  - trigger: state
    entity_id: input_boolean.auto_light_override
    to: 'on'
    id: Override On
  - trigger: state
    entity_id: input_boolean.auto_light_override
    to: 'off'
    id: Override Off
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: Override On
      sequence:
      - action: light.turn_on
        target:
          entity_id: light.kitchen
    - conditions:
      - condition: trigger
        id: Override Off
      sequence:
      - action: light.turn_off
        target:
          entity_id: light.kitchen
  mode: single

# ==========================================
# PRESENCE STATUS
# ==========================================

- id: '1758236067471'
  alias: Presence: Family Status Update
  description: Updates presence status for Brandon using blueprint
  use_blueprint:
    path: fixtse/presence_non_binary.yaml
    input:
      person_device_tracker: person.brandon
      person_input_select: input_select.presence_status_dropdown
- id: '1758506529731'
  alias: Security: Auto-Lock Side Door When Closed
  description: Auto-locks side door 20 minutes after being closed
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.dining_room_door_opening
    to: 'off'
    for:
      hours: 0
      minutes: 20
      seconds: 0
  conditions:
  - condition: state
    entity_id: binary_sensor.dining_room_door_opening
    state: 'off'
  actions:
  - device_id: 7ed6947d7f1c31e7bb668bbd37c89611  # Side door lock device
    domain: lock
    entity_id: e502f8fb1ee7c3fd687bed48d36f85f0  # Side door lock entity
    type: lock
  mode: single
- id: '1758677904526'
  alias: Lighting: Turn Off Downstairs Lights at Night
  description: Turns off downstairs and patio lights at 11:30 PM
  triggers:
  - trigger: time
    at: '23:30:00'
  actions:
  - action: light.turn_off
    target:
      floor_id: downstairs
      entity_id: light.patio_lights_basic
  mode: single
- id: '1758937395960'
  alias: Modes: Disable After-Bedtime Mode at Wakeup
  description: Disables after-bedtime mode at wakeup time
  triggers:
  - trigger: time
    at: input_datetime.wakeuptime
  actions:
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.after_bedtime
  mode: single
- id: '1758937882630'
  alias: Lighting: Entryway Motion Light After Bedtime
  description: Dims entryway light to 30% on motion during bedtime hours
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.4_in_1_sensor_home_security_motion_detection
    to: 'on'
    id: Motion Detected
  - trigger: state
    entity_id:
    - binary_sensor.4_in_1_sensor_home_security_motion_detection
    to: 'off'
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: Clear
  conditions:
  - condition: state
    entity_id: input_boolean.after_bedtime
    state: 'on'
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - Motion Detected
      sequence:
      - action: light.turn_on
        data:
          brightness_pct: 30
        target:
          entity_id: light.hue_white_lamp_1_12
    - conditions:
      - condition: trigger
        id:
        - Clear
      sequence:
      - action: light.turn_off
        target:
          entity_id: light.hue_white_lamp_1_12
  mode: restart
- id: '1758975893651'
  alias: Lighting: Entryway Auto-Brightness Control
  description: Turns light on when lux is low, off when lux is high, prevents flicker,
    rechecks periodically and at startup
  triggers:
  - trigger: numeric_state
    entity_id: sensor.4_in_1_sensor_illuminance
    below: 70
    id: Low Light
  - trigger: numeric_state
    entity_id: sensor.4_in_1_sensor_illuminance
    above: 90
    id: Bright Light
  - trigger: time_pattern
    minutes: /5
    id: Periodic Check
  - trigger: homeassistant
    event: start
    id: Startup Check
  conditions:
  - condition: state
    entity_id: input_boolean.after_bedtime
    state: 'off'
  actions:
  - choose:
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id: Low Light
        - condition: and
          conditions:
          - condition: trigger
            id:
            - Periodic Check
            - Startup Check
          - condition: numeric_state
            entity_id: sensor.4_in_1_sensor_illuminance
            below: 70
      sequence:
      - action: light.turn_on
        target:
          entity_id: light.hue_white_lamp_1_12
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id: Bright Light
        - condition: and
          conditions:
          - condition: trigger
            id:
            - Periodic Check
            - Startup Check
          - condition: numeric_state
            entity_id: sensor.4_in_1_sensor_illuminance
            above: 90
      sequence:
      - action: light.turn_off
        target:
          entity_id: light.hue_white_lamp_1_12
  initial_state: true
  mode: single

# ==========================================
# DISHWASHER MONITORING
# ==========================================

- id: '1758979279450'
  alias: Dishwasher Power Monitoring
  description: Tracks dishwasher power usage and sends notification when cycle completes
  triggers:
  - trigger: numeric_state
    id: dishwasher_on
    entity_id:
    - sensor.dishwasher_energy_monitor_current_consumption
    above: 50
    for:
      minutes: 3
  - trigger: numeric_state
    id: dishwasher_off
    entity_id:
    - sensor.dishwasher_energy_monitor_current_consumption
    below: 8
    for:
      minutes: 3
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: dishwasher_on
      - condition: state
        entity_id: input_boolean.dishwasher
        state: 'off'
      sequence:
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.dishwasher
    - conditions:
      - condition: trigger
        id: dishwasher_off
      - condition: state
        entity_id: input_boolean.dishwasher
        state: 'on'
      sequence:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.dishwasher
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.dishwasher_notification_button
  mode: single
